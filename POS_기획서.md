# POS 프로그램 기획서 (v1.1)

## 1. 목표 및 배경
- 음식점·카페·유통 매장에서 사용할 통합 POS를 개발한다.
- Android/Windows 동시 지원, 키오스크 모드, 대형 매장의 멀티 POS, 프랜차이즈 본사/지점 관리까지 확장 가능한 구조를 목표로 한다.
- Toss POS(토스플레이스) UI/구성을 레퍼런스로 삼되, 직접 복제는 지양하고 업무 흐름·학습 비용을 낮추는 방향으로 재해석한다.
- 한국 시장 사용을 전제로 하며, VAN 연동은 **금융결제원(KFTC)** 을 1차 대상으로 한다.

## 2. 확정된 기술 스택

| 영역 | 선택 | 비고 |
|------|------|------|
| **클라이언트** | Flutter | Android/Windows 단일 코드베이스, 하드웨어 연동 용이 |
| **서버** | NestJS + Prisma | TypeScript, 타입 안전성, 스키마 중심 개발 |
| **DB** | PostgreSQL | 멀티테넌트, JSONB 지원 |
| **실시간** | WebSocket | 주문/상태 브로드캐스트 |
| **웹 관리자** | React/Next.js | 대시보드, 메뉴 관리 |

## 3. 확정된 하드웨어 연동

### 1차 지원 대상
| 장비 | 모델 | 연결 방식 |
|------|------|-----------|
| **영수증 프린터** | POSBANK A11 (3인치) | USB, Network(TCP/IP) |
| **카드 단말기** | 금융결제원 KFTCOneCAP 연동 | 소켓 통신 (localhost) |
| **서명패드** | 금융결제원 연동 서명패드 | COM 포트 (시리얼) |

### VAN 연동: 금융결제원 (KFTC)
- **에이전트**: KFTCOneCAP.exe (C:\Program Files (x86)\KFTCOneCAP)
- **통신 방식**: 로컬 소켓 또는 OCX (KFTC_AsyncforPOS.ocx)
- **서버**: www.kftcvan.or.kr:8002
- **프로토콜**: 독립형 POS 프로토콜 명세서 참조

## 4. 레퍼런스 (Toss POS 확인 항목)
- **멀티 디바이스/OS 지원**: 토스 POS 앱은 Windows/Android/iOS/Mac에서 동작
- **키오스크 모드 전환**: POS에서 모드 전환 시 키오스크로 동작
- **QR 테이블 오더**: QR 테이블 오더 기능을 제공
- **배달앱 연동**: 배달의민족·쿠팡이츠·요기요 연동 및 실시간 매출 통합
- **쿠폰/포인트 기반 고객관리**: 포인트 적립 및 쿠폰 발행 기능
- **매장 운영 기능(식당 기준)**: 테이블 주문, 테이블 편집, 재고 관리, 고객 분석

## 5. 요구사항 정리
- Toss 스타일 UI/업무 흐름 레퍼런스
- 웹에서 메뉴·매출·테이블 편집을 동시에 관리하고 POS와 실시간 동기화
- 대형 매장 다중 POS 지원 (동시 주문/결제/주문흐름)
- Android/Windows 동시 지원 (Flutter)
- 키오스크 동일 프로그램에서 비율/화면 자동 대응
- 프랜차이즈 본사/지점 다중 매장 관리
- 장비 연결 방식: USB / Bluetooth / 시리얼 / Network(TCP/IP)
- 바코드 스캐너: USB 기본 + Bluetooth 지원

## 6. 범위 정의

### In-Scope (1차 MVP)
- POS 기본 업무: 주문, 결제, 할인, 영수증, 반품
- 금융결제원(KFTC) 카드 결제 연동
- POSBANK A11 영수증 프린터 연동
- 웹 관리자: 메뉴/가격/옵션 관리
- 기본 매출 조회

### In-Scope (v1)
- 테이블 관리: 테이블 배치/수정, 주문 상태 흐름
- 멀티 POS 동기화
- 쿠폰/포인트 기본 기능
- 오프라인 캐시 및 네트워크 복구 동기화

### In-Scope (v1.5)
- 키오스크 모드
- 프랜차이즈 본사 기능
- QR 테이블 오더

### Out-of-Scope (후속)
- 복잡한 ERP/회계 연동
- 자체 결제단말기 하드웨어 개발
- 배달앱 연동 (v2)
- 대규모 옴니채널(온라인몰) 통합

## 7. 핵심 사용자 시나리오
- **캐셔**: 주문 입력 → 할인/쿠폰 → 결제(KFTC) → 영수증 출력(A11)
- **매장 관리자**: 메뉴/가격 변경 → POS 즉시 반영 → 매출 확인
- **본사 관리자**: 표준 메뉴/가격 정책 배포 → 지점별 예외 승인
- **키오스크 고객**: 셀프 주문 → 결제 → 주문번호 호출

## 8. 기능 상세 (MVP → 확장)

### POS 클라이언트 (Flutter)
- 주문/결제 흐름
- 멀티 주문 동시 처리
- 테이블 배치 편집(그리드/자유 배치)
- 쿠폰·포인트 적용
- 영수증 프린터 연동 (POSBANK A11)
- 오프라인 캐시 및 네트워크 복구 동기화
- 듀얼모니터 화면 분리(캐셔 화면/고객 표시 화면)
- 카드 결제 연동 (KFTC OneCAP)
- 바코드 스캔 입력 흐름

### 키오스크 모드 (v1.5)
- 동일 앱에서 '키오스크 모드' 전환
- 대화면/세로형 비율 대응
- 접근성(큰 버튼, 단순 단계)

### 웹 관리자 (Back Office)
- 메뉴/옵션/세트/알러지 정보 관리
- 가격 스케줄(시간대별 가격) - v2
- 재고/입출고
- 매출·카테고리 분석
- 멀티 POS 상태 모니터링

### 프랜차이즈 본사 기능 (v1.5)
- 매장/지점 계정 관리
- 표준 메뉴 템플릿 배포
- 지점별 예외 정책(가격/품절)
- 전사 매출 대시보드

## 9. 기술 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                        클라이언트                            │
├─────────────────────────────────────────────────────────────┤
│  Flutter App (Android/Windows)                              │
│  ├── UI Layer (Riverpod/BLoC)                              │
│  ├── Local DB (SQLite/Drift)                               │
│  ├── Hardware Layer                                         │
│  │   ├── POSBANK A11 (ESC/POS over USB/TCP)               │
│  │   ├── KFTC OneCAP (Socket/OCX)                          │
│  │   └── Barcode Scanner (USB HID)                         │
│  └── Sync Engine (Offline-first)                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ REST API + WebSocket
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         서버                                 │
├─────────────────────────────────────────────────────────────┤
│  NestJS API Server                                          │
│  ├── Auth Module (JWT)                                      │
│  ├── Store/Menu/Order Modules                               │
│  ├── Payment Module (VAN Abstraction)                       │
│  ├── WebSocket Gateway                                      │
│  └── Prisma ORM                                             │
│                              │                              │
│                              ▼                              │
│                      PostgreSQL                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    웹 관리자 (Back Office)                   │
├─────────────────────────────────────────────────────────────┤
│  Next.js Dashboard                                          │
│  ├── 메뉴/가격 관리                                          │
│  ├── 매출 분석                                               │
│  └── 매장/디바이스 모니터링                                   │
└─────────────────────────────────────────────────────────────┘
```

## 10. 데이터 모델 (요약)
- Store, Franchise, Device, User, Role
- Menu, Category, Option, Modifier, **Set (세트메뉴)**
- Table, Order, OrderItem, Payment
- **Coupon, Promotion** (추가)
- Loyalty, Customer
- Inventory, StockMovement
- **AuditLog** (추가)

## 11. 개발 로드맵 (제안)

### Phase 1: MVP
- [ ] NestJS + Prisma 기본 구조
- [ ] 인증/권한 (JWT)
- [ ] 매장/메뉴 CRUD API
- [ ] 주문/결제 기본 흐름
- [ ] Flutter 앱 기본 UI
- [ ] KFTC OneCAP 결제 연동
- [ ] POSBANK A11 프린터 연동

### Phase 2: v1
- [ ] 테이블 관리
- [ ] 멀티 POS WebSocket 동기화
- [ ] 오프라인 모드 + 동기화
- [ ] 쿠폰/포인트
- [ ] 웹 관리자 대시보드

### Phase 3: v1.5
- [ ] 키오스크 모드
- [ ] 프랜차이즈 본사 기능
- [ ] QR 테이블 오더

### Phase 4: v2
- [ ] 배달앱 연동
- [ ] 추가 VAN (KIS, KPN)
- [ ] 고급 분석/리포트

## 12. 리스크 및 고려사항
- **결제/보안**: 금융결제원 연동 테스트 환경 필요
- **하드웨어 호환성**: POSBANK A11 외 프린터 점진적 추가
- **오프라인 충돌**: 동시 주문/수정 충돌 해결 정책 (서버 우선 + 버전 체크)
- **KFTC 에이전트 의존성**: Windows에서 KFTCOneCAP.exe 실행 필수

## 13. 부록: KFTC 연동 정보

### 에이전트 경로
```
C:\Program Files (x86)\KFTCOneCAP\
├── KFTCOneCAP.exe          # 메인 에이전트
├── KFTCPOS3.dll            # 결제 처리 DLL
├── KFTC_AsyncforPOS.ocx    # OCX 컴포넌트
├── kftcwebapi3.dll         # Web API
└── [프로토콜 명세서].hwp   # 연동 문서
```

### 로그 경로
```
C:\KFTC_PosAgent\
├── OneCAPLog\    # 에이전트 로그
├── ForPosLog\    # POS 통신 로그
└── kftclog\      # 결제 로그
```

### 통신 설정
- 서버: www.kftcvan.or.kr:8002
- 무서명 한도: 50,000원
- 통신 방식: 소켓 / OCX

---

*문서 버전: v1.1 (2026-02-05 업데이트)*
